const express = require('express');
const bodyParser = require('body-parser');
const oracledb = require('oracledb');
const path = require('path');

const app = express();

// Configurer le mode "thick"
oracledb.initOracleClient({ libDir: '/opt/oracle/instantclient_23_4' });

const dbConfig = {
    user: 'torresl',
    password: '06092004',
    connectString: '(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=162.38.222.149)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=IUT)))'
};

oracledb.autoCommit = true;

app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, 'public')));

app.post('/submit', async (req, res) => {
    const { nom, prenom, email, mdp } = req.body;

    let connection;

    try {
        connection = await oracledb.getConnection(dbConfig);
        const result = await connection.execute(
            `INSERT INTO users (email, nom, prenom, mdp) VALUES (:email, :nom, :prenom, :mdp)`,
            [email, nom, prenom, mdp]
        );
        res.status(200).send("Données enregistrées avec succès.");
    } catch (err) {
        console.error(err);
        res.status(500).send("Erreur lors de l'enregistrement des données.");
    } finally {
        if (connection) {
            try {
                await connection.close();
            } catch (err) {
                console.error(err);
            }
        }
    }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
    console.log(`Serveur démarré sur le port ${PORT}`);
});
